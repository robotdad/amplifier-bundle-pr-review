name: "pr-review-full"
description: "Complete PR review workflow for amplifier-app-cli"
version: "2.2.0"
author: "Amplifier PR Review Bundle"
tags: ["pr-review", "amplifier", "testing"]

# Usage:
#   amplifier tool invoke recipes operation=execute \
#     recipe_path=@pr-review:recipes/pr-review-full.yaml \
#     context='{"pr_url": "https://github.com/microsoft/amplifier-app-cli/pull/65"}'

context:
  pr_url: ""
  workspace_base: "./pr-review"
  skip_shadow_tests: false
  skip_llm_smoke: false

steps:
  # ============================================================================
  # PHASE 1: SETUP AND FETCH PR INFO
  # ============================================================================
  
  - id: "init-workspace"
    type: "bash"
    command: |
      set -e
      mkdir -p "{{workspace_base}}"
      cd "{{workspace_base}}"
      echo "{\"workspace\": \"$(pwd)\"}"
    output: "paths"
    parse_json: true
    timeout: 30

  - id: "parse-pr-url"
    type: "bash"
    command: |
      set -e
      PR_URL="{{pr_url}}"
      
      if [[ ! "$PR_URL" =~ github\.com/([^/]+)/([^/]+)/pull/([0-9]+) ]]; then
        echo "ERROR: Invalid PR URL: $PR_URL" >&2
        exit 1
      fi
      
      echo "{\"owner\": \"${BASH_REMATCH[1]}\", \"repo\": \"${BASH_REMATCH[2]}\", \"pr_number\": \"${BASH_REMATCH[3]}\", \"full_repo\": \"${BASH_REMATCH[1]}/${BASH_REMATCH[2]}\"}"
    output: "pr_info"
    parse_json: true
    timeout: 30

  - id: "fetch-pr-metadata"
    type: "bash"
    command: |
      set -e
      gh pr view {{pr_info.pr_number}} \
        --repo {{pr_info.full_repo}} \
        --json title,body,headRefName,headRefOid,baseRefName,author,additions,deletions,changedFiles,url
    output: "pr_meta"
    parse_json: true
    timeout: 60

  - id: "fetch-changed-files"
    type: "bash"
    command: |
      set -e
      gh pr diff {{pr_info.pr_number}} \
        --repo {{pr_info.full_repo}} \
        --name-only | sort -u | head -100
    output: "changed_files"
    timeout: 60

  # ============================================================================
  # PHASE 2: CLONE REPOS
  # ============================================================================

  - id: "clone-pr-repo"
    type: "bash"
    command: |
      set -e
      cd "{{paths.workspace}}"
      
      REPO="{{pr_info.full_repo}}"
      COMMIT="{{pr_meta.headRefOid}}"
      REPO_DIR="{{pr_info.repo}}"
      
      echo "Cloning $REPO at commit $COMMIT..."
      
      if [ -d "$REPO_DIR" ]; then
        echo "Repo exists, fetching..."
        cd "$REPO_DIR"
        git fetch origin
      else
        echo "Cloning repo..."
        gh repo clone "$REPO" "$REPO_DIR"
        cd "$REPO_DIR"
      fi
      
      # Fetch the specific commit (needed for closed PRs - commit may not be in shallow clone)
      echo "Fetching commit $COMMIT..."
      git fetch origin "$COMMIT" || git fetch --unshallow origin || true
      
      # Checkout the specific commit
      echo "Checking out commit $COMMIT..."
      git checkout "$COMMIT"
      
      # Verify we're in the repo at the right commit
      if [ ! -d ".git" ]; then
        echo "ERROR: Clone failed - no .git directory" >&2
        exit 1
      fi
      
      ACTUAL=$(git rev-parse HEAD)
      echo "Expected commit: $COMMIT"
      echo "Actual commit:   $ACTUAL"
      
      if [ "$ACTUAL" != "$COMMIT" ]; then
        echo "ERROR: Commit mismatch" >&2
        exit 1
      fi
      
      # Output absolute path
      pwd
    output: "pr_repo_path"
    timeout: 300

  - id: "clone-core"
    type: "bash"
    command: |
      set -e
      cd "{{paths.workspace}}"
      
      if [ -d "amplifier-core" ]; then
        echo "Core exists, updating..."
        cd amplifier-core
        git fetch origin main
        git checkout main
        git pull
      else
        echo "Cloning amplifier-core..."
        gh repo clone microsoft/amplifier-core
        cd amplifier-core
      fi
      
      if [ ! -d ".git" ]; then
        echo "ERROR: Core clone failed" >&2
        exit 1
      fi
      
      pwd
    output: "core_path"
    timeout: 180

  # ============================================================================
  # PHASE 3: CROSS-REPO CONTRACT CHECK
  # ============================================================================

  - id: "cross-repo-check"
    agent: "foundation:explorer"
    prompt: |
      Check for cross-repo contract violations.
      
      PR repo: {{pr_repo_path}}
      Core repo: {{core_path}}
      
      1. Find function/method signature changes in the PR
      2. Search core for usages of those interfaces
      3. Flag if core calls methods with removed parameters
      
      Report: SAFE or WARNING with details
    output: "cross_repo_result"
    timeout: 300

  # ============================================================================
  # PHASE 4: SHADOW ENVIRONMENT TESTING
  # ============================================================================

  - id: "create-shadow"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      set -e
      echo "Creating shadow with PR repo: {{pr_repo_path}}"
      
      # Verify the path exists
      if [ ! -d "{{pr_repo_path}}" ]; then
        echo "ERROR: PR repo path does not exist: {{pr_repo_path}}" >&2
        exit 1
      fi
      
      amplifier tool invoke shadow \
        operation=create \
        name="pr-review-{{pr_info.pr_number}}" \
        local_sources="[\"{{pr_repo_path}}:{{pr_info.full_repo}}\"]"
    output: "shadow"
    parse_json: true
    timeout: 300

  - id: "shadow-install"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      set -e
      echo "Installing Amplifier from local clone..."
      
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="uv tool install /workspace/{{pr_info.full_repo}} && amplifier --version"
      
      echo "Installing providers..."
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier provider install -q 2>/dev/null || true"
      
      echo "Installing smoke test bundle..."
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier bundle add git+https://github.com/samueljklee/amplifier-bundle-smoke-test --app"
    output: "install_result"
    timeout: 600

  - id: "shadow-smoke-test"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      set -e
      echo "Running smoke tests..."
      
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier tool invoke recipes operation=execute recipe_path=@smoke-test:recipes/smoke-test.yaml context='{\"skip_llm\": {{skip_llm_smoke}}}'"
    output: "smoke_results"
    timeout: 900

  - id: "destroy-shadow"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      amplifier tool invoke shadow \
        operation=destroy \
        shadow_id="{{shadow.shadow_id}}" || true
    output: "cleanup"
    on_error: "continue"
    timeout: 60

  # ============================================================================
  # PHASE 5: CODE REVIEW
  # ============================================================================

  - id: "code-review"
    agent: "foundation:zen-architect"
    mode: "REVIEW"
    prompt: |
      Review PR for code quality.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}} - {{pr_meta.title}}
      Changed files: {{changed_files}}
      Repo path: {{pr_repo_path}}
      
      Assess architecture, code quality, Amplifier patterns.
    output: "code_review"
    timeout: 600

  - id: "security-review"
    agent: "foundation:security-guardian"
    prompt: |
      Security audit of PR changes.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}}
      Changed files: {{changed_files}}
      Repo path: {{pr_repo_path}}
      
      Check OWASP issues, injection, path traversal, secrets.
    output: "security_review"
    timeout: 600

  - id: "python-check"
    type: "bash"
    command: |
      amplifier tool invoke python_check \
        paths="[\"{{pr_repo_path}}\"]" 2>&1 || echo "Check completed"
    output: "python_results"
    timeout: 300

  # ============================================================================
  # PHASE 6: GENERATE REPORT
  # ============================================================================

  - id: "synthesize"
    agent: "foundation:zen-architect"
    mode: "ARCHITECT"
    prompt: |
      Create PR review report.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}}: {{pr_meta.title}}
      Author: {{pr_meta.author.login}}
      Commit: {{pr_meta.headRefOid}}
      
      Results:
      - Cross-repo: {{cross_repo_result}}
      - Shadow install: {{install_result}}
      - Smoke tests: {{smoke_results}}
      - Code review: {{code_review}}
      - Security: {{security_review}}
      - Python: {{python_results}}
      
      Format as GitHub PR comment with executive summary, test results, issues, suggestions.
    output: "report"
    timeout: 600

  - id: "save-report"
    type: "bash"
    command: |
      set -e
      cat > "{{paths.workspace}}/pr-{{pr_info.pr_number}}-review.md" << 'EOF'
      {{report}}
      EOF
      
      realpath "{{paths.workspace}}/pr-{{pr_info.pr_number}}-review.md"
    output: "final_output"
    timeout: 30
