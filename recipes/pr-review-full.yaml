name: "pr-review-full"
description: "Complete PR review workflow for amplifier-app-cli"
version: "2.3.0"
author: "Amplifier PR Review Bundle"
tags: ["pr-review", "amplifier", "testing"]

# Usage:
#   amplifier tool invoke recipes operation=execute \
#     recipe_path=@pr-review:recipes/pr-review-full.yaml \
#     context='{"pr_url": "https://github.com/microsoft/amplifier-app-cli/pull/65"}'

context:
  pr_url: ""
  workspace_base: "./pr-review"
  skip_shadow_tests: false
  skip_llm_smoke: false

steps:
  # ============================================================================
  # PHASE 1: SETUP AND FETCH PR INFO
  # ============================================================================
  
  - id: "init-workspace"
    type: "bash"
    command: |
      set -e
      mkdir -p "{{workspace_base}}"
      cd "{{workspace_base}}"
      echo "{\"workspace\": \"$(pwd)\"}"
    output: "paths"
    parse_json: true
    timeout: 30

  - id: "parse-pr-url"
    type: "bash"
    command: |
      set -e
      PR_URL="{{pr_url}}"
      
      if [[ ! "$PR_URL" =~ github\.com/([^/]+)/([^/]+)/pull/([0-9]+) ]]; then
        echo "ERROR: Invalid PR URL: $PR_URL" >&2
        exit 1
      fi
      
      echo "{\"owner\": \"${BASH_REMATCH[1]}\", \"repo\": \"${BASH_REMATCH[2]}\", \"pr_number\": \"${BASH_REMATCH[3]}\", \"full_repo\": \"${BASH_REMATCH[1]}/${BASH_REMATCH[2]}\"}"
    output: "pr_info"
    parse_json: true
    timeout: 30

  - id: "fetch-pr-metadata"
    type: "bash"
    command: |
      set -e
      gh pr view {{pr_info.pr_number}} \
        --repo {{pr_info.full_repo}} \
        --json title,body,headRefName,headRefOid,baseRefName,author,additions,deletions,changedFiles,url
    output: "pr_meta"
    parse_json: true
    timeout: 60

  - id: "fetch-changed-files"
    type: "bash"
    command: |
      set -e
      gh pr diff {{pr_info.pr_number}} \
        --repo {{pr_info.full_repo}} \
        --name-only | sort -u | head -100
    output: "changed_files"
    timeout: 60

  # ============================================================================
  # PHASE 2: CLONE REPOS
  # ============================================================================

  - id: "clone-pr-repo"
    type: "bash"
    command: |
      set -e
      cd "{{paths.workspace}}"
      
      REPO="{{pr_info.full_repo}}"
      COMMIT="{{pr_meta.headRefOid}}"
      REPO_DIR="{{pr_info.repo}}"
      
      echo "Cloning $REPO at commit $COMMIT..." >&2
      
      if [ -d "$REPO_DIR" ]; then
        echo "Repo exists, fetching..." >&2
        cd "$REPO_DIR"
        git fetch origin >&2
      else
        echo "Cloning repo..." >&2
        gh repo clone "$REPO" "$REPO_DIR" >&2
        cd "$REPO_DIR"
      fi
      
      echo "Fetching commit $COMMIT..." >&2
      git fetch origin "$COMMIT" >&2 2>&1 || git fetch --unshallow origin >&2 2>&1 || true
      
      echo "Checking out commit $COMMIT..." >&2
      git checkout "$COMMIT" >&2
      
      if [ ! -d ".git" ]; then
        echo "ERROR: Clone failed - no .git directory" >&2
        exit 1
      fi
      
      ACTUAL=$(git rev-parse HEAD)
      echo "Expected: $COMMIT, Actual: $ACTUAL" >&2
      
      if [ "$ACTUAL" != "$COMMIT" ]; then
        echo "ERROR: Commit mismatch" >&2
        exit 1
      fi
      
      pwd
    output: "pr_repo_path"
    timeout: 300

  - id: "clone-core"
    type: "bash"
    command: |
      set -e
      cd "{{paths.workspace}}"
      
      if [ -d "amplifier-core" ]; then
        cd amplifier-core
        git fetch origin main >&2
        git checkout main >&2
        git pull >&2
      else
        gh repo clone microsoft/amplifier-core >&2
        cd amplifier-core
      fi
      
      if [ ! -d ".git" ]; then
        echo "ERROR: Core clone failed" >&2
        exit 1
      fi
      
      pwd
    output: "core_path"
    timeout: 180

  # ============================================================================
  # PHASE 3: CODE ANALYSIS (runs BEFORE shadow tests so we get results even if shadow fails)
  # ============================================================================

  - id: "cross-repo-check"
    agent: "foundation:explorer"
    prompt: |
      Check for cross-repo contract violations between the PR and amplifier-core.
      
      PR repo: {{pr_repo_path}}
      Core repo: {{core_path}}
      Changed files in PR: {{changed_files}}
      
      Tasks:
      1. Examine the changed files in the PR repo
      2. Identify any function/method signature changes (especially in resolvers, protocols, public APIs)
      3. Search core repo for usages of those interfaces
      4. Flag if core calls methods with parameters the PR removes or changes
      
      Output a structured report with:
      - VERDICT: SAFE or WARNING
      - Summary of what you found
      - Specific file:line references for any issues
    output: "cross_repo_result"
    timeout: 300

  - id: "code-review"
    agent: "foundation:zen-architect"
    mode: "REVIEW"
    prompt: |
      Review this PR for code quality and architecture.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}} - {{pr_meta.title}}
      Author: {{pr_meta.author.login}}
      Commit: {{pr_meta.headRefOid}}
      Changed files: {{changed_files}}
      Repo path: {{pr_repo_path}}
      
      Assess:
      - Architecture and design patterns
      - Code quality and readability
      - Amplifier-specific patterns and philosophy alignment
      - Potential issues or improvements
      
      Provide specific recommendations with file:line references.
    output: "code_review"
    timeout: 600

  - id: "security-review"
    agent: "foundation:security-guardian"
    prompt: |
      Security audit of PR changes.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}} - {{pr_meta.title}}
      Changed files: {{changed_files}}
      Repo path: {{pr_repo_path}}
      
      Check for:
      - OWASP Top 10 issues
      - Command injection vulnerabilities
      - Path traversal risks
      - Hardcoded secrets or credentials
      - Unsafe dependencies
      
      Provide PASS/FAIL verdict with specific findings.
    output: "security_review"
    timeout: 600

  - id: "python-check"
    type: "bash"
    command: |
      PR_PATH=$(echo "{{pr_repo_path}}" | tr -d '\n\r')
      amplifier tool invoke python_check paths="[\"${PR_PATH}\"]" 2>&1 || echo "Check completed"
    output: "python_results"
    timeout: 300

  # Save analysis results to disk BEFORE shadow tests
  - id: "save-analysis"
    type: "bash"
    command: |
      set -e
      WORKSPACE=$(echo "{{paths.workspace}}" | tr -d '\n\r')
      
      cat > "${WORKSPACE}/pr-{{pr_info.pr_number}}-analysis.md" << 'ANALYSIS_EOF'
      # PR Analysis Report: {{pr_info.full_repo}}#{{pr_info.pr_number}}
      
      **Title:** {{pr_meta.title}}
      **Author:** {{pr_meta.author.login}}
      **Commit:** {{pr_meta.headRefOid}}
      **Changed Files:** {{pr_meta.changedFiles}}
      
      ---
      
      ## Cross-Repo Contract Check
      
      {{cross_repo_result}}
      
      ---
      
      ## Code Review
      
      {{code_review}}
      
      ---
      
      ## Security Review
      
      {{security_review}}
      
      ---
      
      ## Python Quality Check
      
      {{python_results}}
      
      ---
      
      *Analysis completed. Shadow environment testing pending.*
      ANALYSIS_EOF
      
      echo "Analysis saved to: ${WORKSPACE}/pr-{{pr_info.pr_number}}-analysis.md" >&2
      realpath "${WORKSPACE}/pr-{{pr_info.pr_number}}-analysis.md"
    output: "analysis_report_path"
    timeout: 30

  # ============================================================================
  # PHASE 4: SHADOW ENVIRONMENT TESTING
  # ============================================================================

  - id: "create-shadow"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      set -e
      PR_PATH=$(echo "{{pr_repo_path}}" | tr -d '\n\r')
      
      echo "Creating shadow with PR repo: $PR_PATH" >&2
      
      if [ ! -d "$PR_PATH" ]; then
        echo "ERROR: PR repo path does not exist: $PR_PATH" >&2
        exit 1
      fi
      
      amplifier tool invoke shadow \
        operation=create \
        name="pr-review-{{pr_info.pr_number}}" \
        local_sources="[\"${PR_PATH}:{{pr_info.full_repo}}\"]"
    output: "shadow"
    parse_json: true
    timeout: 300

  - id: "shadow-install"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      set -e
      echo "Installing Amplifier from local clone..." >&2
      
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="uv tool install /workspace/{{pr_info.full_repo}} && amplifier --version"
      
      echo "Installing providers..." >&2
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier provider install -q 2>/dev/null || true"
      
      echo "Installing smoke test bundle..." >&2
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier bundle add git+https://github.com/samueljklee/amplifier-bundle-smoke-test --app"
    output: "install_result"
    timeout: 600

  - id: "shadow-smoke-test"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      set -e
      echo "Running smoke tests..." >&2
      
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier tool invoke recipes operation=execute recipe_path=@smoke-test:recipes/smoke-test.yaml context='{\"skip_llm\": {{skip_llm_smoke}}}'"
    output: "smoke_results"
    timeout: 900

  - id: "destroy-shadow"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      amplifier tool invoke shadow \
        operation=destroy \
        shadow_id="{{shadow.shadow_id}}" || true
    output: "cleanup"
    on_error: "continue"
    timeout: 60

  # ============================================================================
  # PHASE 5: FINAL REPORT
  # ============================================================================

  - id: "synthesize"
    agent: "foundation:zen-architect"
    mode: "ARCHITECT"
    prompt: |
      Create final PR review report combining all analysis and test results.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}}: {{pr_meta.title}}
      Author: {{pr_meta.author.login}}
      Commit: {{pr_meta.headRefOid}}
      
      Results:
      - Cross-repo contract check: {{cross_repo_result}}
      - Code review: {{code_review}}
      - Security review: {{security_review}}
      - Python checks: {{python_results}}
      - Shadow install: {{install_result}}
      - Smoke tests: {{smoke_results}}
      
      Format as a GitHub PR comment with:
      1. Executive summary with overall verdict (APPROVE / REQUEST_CHANGES / COMMENT)
      2. Test results summary (PASS/FAIL for each category)
      3. Critical issues that must be addressed
      4. Suggestions for improvement
      5. Positive notes about the PR
    output: "report"
    timeout: 600

  - id: "save-report"
    type: "bash"
    command: |
      set -e
      WORKSPACE=$(echo "{{paths.workspace}}" | tr -d '\n\r')
      
      cat > "${WORKSPACE}/pr-{{pr_info.pr_number}}-review.md" << 'EOF'
      {{report}}
      EOF
      
      realpath "${WORKSPACE}/pr-{{pr_info.pr_number}}-review.md"
    output: "final_output"
    timeout: 30
