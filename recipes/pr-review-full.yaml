name: "pr-review-full"
description: "Complete PR review workflow for amplifier-app-cli"
version: "2.6.0"
author: "Amplifier PR Review Bundle"
tags: ["pr-review", "amplifier", "testing"]

# Usage:
#   amplifier tool invoke recipes operation=execute \
#     recipe_path=@pr-review:recipes/pr-review-full.yaml \
#     context='{"pr_url": "https://github.com/microsoft/amplifier-app-cli/pull/65"}'

context:
  pr_url: ""
  workspace_base: "./pr-review"
  skip_shadow_tests: false
  skip_llm_smoke: false

steps:
  # ============================================================================
  # PHASE 1: SETUP AND FETCH PR INFO
  # ============================================================================
  
  - id: "init-workspace"
    type: "bash"
    command: |
      set -e
      mkdir -p "{{workspace_base}}"
      cd "{{workspace_base}}"
      echo "{\"workspace\": \"$(pwd)\"}"
    output: "paths"
    parse_json: true
    timeout: 30

  - id: "parse-pr-url"
    type: "bash"
    command: |
      set -e
      PR_URL="{{pr_url}}"
      
      if [[ ! "$PR_URL" =~ github\.com/([^/]+)/([^/]+)/pull/([0-9]+) ]]; then
        echo "ERROR: Invalid PR URL: $PR_URL" >&2
        exit 1
      fi
      
      echo "{\"owner\": \"${BASH_REMATCH[1]}\", \"repo\": \"${BASH_REMATCH[2]}\", \"pr_number\": \"${BASH_REMATCH[3]}\", \"full_repo\": \"${BASH_REMATCH[1]}/${BASH_REMATCH[2]}\"}"
    output: "pr_info"
    parse_json: true
    timeout: 30

  - id: "fetch-pr-metadata"
    type: "bash"
    command: |
      set -e
      gh pr view {{pr_info.pr_number}} \
        --repo {{pr_info.full_repo}} \
        --json title,body,headRefName,headRefOid,baseRefName,author,additions,deletions,changedFiles,url
    output: "pr_meta"
    parse_json: true
    timeout: 60

  - id: "fetch-changed-files"
    type: "bash"
    command: |
      set -e
      gh pr diff {{pr_info.pr_number}} \
        --repo {{pr_info.full_repo}} \
        --name-only | sort -u | head -100
    output: "changed_files"
    timeout: 60

  # ============================================================================
  # PHASE 2: CLONE REPOS
  # ============================================================================

  - id: "clone-pr-repo"
    type: "bash"
    command: |
      set -e
      cd "{{paths.workspace}}"
      
      REPO="{{pr_info.full_repo}}"
      COMMIT="{{pr_meta.headRefOid}}"
      REPO_DIR="{{pr_info.repo}}"
      
      echo "Cloning $REPO at commit $COMMIT..." >&2
      
      if [ -d "$REPO_DIR" ]; then
        echo "Repo exists, fetching..." >&2
        cd "$REPO_DIR"
        git fetch origin >&2
      else
        echo "Cloning repo..." >&2
        gh repo clone "$REPO" "$REPO_DIR" >&2
        cd "$REPO_DIR"
      fi
      
      echo "Fetching commit $COMMIT..." >&2
      git fetch origin "$COMMIT" >&2 2>&1 || git fetch --unshallow origin >&2 2>&1 || true
      
      echo "Checking out commit $COMMIT..." >&2
      git checkout "$COMMIT" >&2
      
      if [ ! -d ".git" ]; then
        echo "ERROR: Clone failed - no .git directory" >&2
        exit 1
      fi
      
      ACTUAL=$(git rev-parse HEAD)
      echo "Expected: $COMMIT, Actual: $ACTUAL" >&2
      
      if [ "$ACTUAL" != "$COMMIT" ]; then
        echo "ERROR: Commit mismatch" >&2
        exit 1
      fi
      
      pwd
    output: "pr_repo_path"
    timeout: 300

  - id: "clone-core"
    type: "bash"
    command: |
      set -e
      cd "{{paths.workspace}}"
      
      if [ -d "amplifier-core" ]; then
        cd amplifier-core
        git fetch origin main >&2
        git checkout main >&2
        git pull >&2
      else
        gh repo clone microsoft/amplifier-core >&2
        cd amplifier-core
      fi
      
      if [ ! -d ".git" ]; then
        echo "ERROR: Core clone failed" >&2
        exit 1
      fi
      
      pwd
    output: "core_path"
    timeout: 180

  # ============================================================================
  # PHASE 3: CODE ANALYSIS (runs BEFORE shadow tests)
  # ============================================================================

  - id: "cross-repo-check"
    agent: "foundation:explorer"
    prompt: |
      Check for cross-repo contract violations between the PR and amplifier-core.
      
      PR repo: {{pr_repo_path}}
      Core repo: {{core_path}}
      Changed files in PR: {{changed_files}}
      
      Tasks:
      1. Examine the changed files in the PR repo
      2. Identify any function/method signature changes (especially in resolvers, protocols, public APIs)
      3. Search core repo for usages of those interfaces
      4. Flag if core calls methods with parameters the PR removes or changes
      
      Output a structured report with:
      - VERDICT: SAFE or WARNING
      - Summary of what you found
      - Specific file:line references for any issues
    output: "cross_repo_result"
    timeout: 300

  - id: "code-review"
    agent: "foundation:zen-architect"
    mode: "REVIEW"
    prompt: |
      Review this PR for code quality and architecture.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}} - {{pr_meta.title}}
      Author: {{pr_meta.author.login}}
      Commit: {{pr_meta.headRefOid}}
      Changed files: {{changed_files}}
      Repo path: {{pr_repo_path}}
      
      Assess:
      - Architecture and design patterns
      - Code quality and readability
      - Amplifier-specific patterns and philosophy alignment
      - Potential issues or improvements
      
      Provide specific recommendations with file:line references.
    output: "code_review"
    timeout: 600

  - id: "security-review"
    agent: "foundation:security-guardian"
    prompt: |
      Security audit of PR changes.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}} - {{pr_meta.title}}
      Changed files: {{changed_files}}
      Repo path: {{pr_repo_path}}
      
      Check for:
      - OWASP Top 10 issues
      - Command injection vulnerabilities
      - Path traversal risks
      - Hardcoded secrets or credentials
      - Unsafe dependencies
      
      Provide PASS/FAIL verdict with specific findings.
    output: "security_review"
    timeout: 600

  - id: "python-check"
    type: "bash"
    command: |
      PR_PATH=$(echo "{{pr_repo_path}}" | tr -d '\n\r')
      amplifier tool invoke python_check paths="[\"${PR_PATH}\"]" 2>&1 || echo "Check completed"
    output: "python_results"
    timeout: 300

  - id: "save-analysis"
    type: "bash"
    command: |
      set -e
      WORKSPACE=$(echo "{{paths.workspace}}" | tr -d '\n\r')
      
      cat > "${WORKSPACE}/pr-{{pr_info.pr_number}}-analysis.md" << 'ANALYSIS_EOF'
      # PR Analysis Report: {{pr_info.full_repo}}#{{pr_info.pr_number}}
      
      **Title:** {{pr_meta.title}}
      **Author:** {{pr_meta.author.login}}
      **Commit:** {{pr_meta.headRefOid}}
      **Changed Files:** {{pr_meta.changedFiles}}
      
      ---
      
      ## Cross-Repo Contract Check
      
      {{cross_repo_result}}
      
      ---
      
      ## Code Review
      
      {{code_review}}
      
      ---
      
      ## Security Review
      
      {{security_review}}
      
      ---
      
      ## Python Quality Check
      
      {{python_results}}
      
      ---
      
      *Analysis completed. Shadow environment testing pending.*
      ANALYSIS_EOF
      
      echo "Analysis saved to: ${WORKSPACE}/pr-{{pr_info.pr_number}}-analysis.md" >&2
      realpath "${WORKSPACE}/pr-{{pr_info.pr_number}}-analysis.md"
    output: "analysis_report_path"
    timeout: 30

  # ============================================================================
  # PHASE 4: SHADOW ENVIRONMENT TESTING
  # Uses INJECT to copy PR code directly - no git cloning inside shadow
  # ============================================================================

  # Step 1: Capture verified baseline BEFORE shadow
  - id: "pre-shadow-baseline"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      set -e
      
      # Get host amplifier version
      HOST_VERSION=$(amplifier --version 2>&1 || echo "NOT_INSTALLED")
      
      # Get verified commit from local PR clone
      PR_PATH=$(echo "{{pr_repo_path}}" | tr -d '\n\r')
      cd "$PR_PATH"
      LOCAL_COMMIT=$(git rev-parse HEAD)
      LOCAL_COMMIT_SHORT=$(git rev-parse --short HEAD)
      
      # Verify it matches expected
      EXPECTED="{{pr_meta.headRefOid}}"
      if [ "$LOCAL_COMMIT" != "$EXPECTED" ]; then
        echo "ERROR: Local clone commit mismatch!" >&2
        echo "  Expected: $EXPECTED" >&2
        echo "  Actual:   $LOCAL_COMMIT" >&2
        exit 1
      fi
      
      # Output as JSON for downstream steps
      cat << EOF
      {
        "host_amplifier_version": "$HOST_VERSION",
        "local_pr_commit_full": "$LOCAL_COMMIT",
        "local_pr_commit_short": "$LOCAL_COMMIT_SHORT",
        "pr_repo_path": "$PR_PATH",
        "verified": true
      }
      EOF
    output: "baseline"
    parse_json: true
    timeout: 30

  # Step 2: Create shadow, inject PR code, run smoke tests
  - id: "shadow-test"
    condition: "{{skip_shadow_tests}} != true"
    agent: "shadow-operator"
    prompt: |
      ## SHADOW ENVIRONMENT SMOKE TEST
      
      Test PR code in an isolated container using DIRECT FILE COPY (not git clone).
      
      ---
      
      ## VERIFIED SOURCE INFORMATION
      
      | Label | Value |
      |-------|-------|
      | **PR Number** | #{{pr_info.pr_number}} |
      | **GitHub Repo** | {{pr_info.full_repo}} |
      | **PR Title** | {{pr_meta.title}} |
      | **VERIFIED PR COMMIT** | `{{baseline.local_pr_commit_full}}` |
      | **Short Commit** | `{{baseline.local_pr_commit_short}}` |
      | **Local Clone Path** | {{baseline.pr_repo_path}} |
      | **Host Amplifier Version** | {{baseline.host_amplifier_version}} |
      
      ---
      
      ## CRITICAL: USE INJECT, NOT LOCAL_SOURCES
      
      The git-based `local_sources` mechanism has a bug where it fetches from remote instead of using local content.
      
      **DO THIS INSTEAD:**
      
      ### 1. Create Empty Shadow
      
      Create a shadow environment WITHOUT local_sources:
      ```
      shadow(operation="create", name="pr-{{pr_info.pr_number}}")
      ```
      
      ### 2. Inject PR Code Directly
      
      Copy the entire PR repo into the shadow using inject:
      ```
      shadow(operation="inject", shadow_id="<id>", host_path="{{baseline.pr_repo_path}}", container_path="/workspace/{{pr_info.full_repo}}")
      ```
      
      This copies the EXACT local files - no git cloning, no Gitea, no remote fetching.
      
      ### 3. Verify Injection
      
      Check the commit inside the shadow:
      ```
      shadow(operation="exec", shadow_id="<id>", command="cd /workspace/{{pr_info.full_repo}} && git rev-parse --short HEAD")
      ```
      
      **MUST show**: `{{baseline.local_pr_commit_short}}`
      
      If it shows a different commit, STOP and report failure.
      
      ### 4. Install Smoke Test Bundle FIRST
      
      **IMPORTANT**: Install the bundle BEFORE installing the PR code. The bundle pulls
      dependencies from @main which may install a different amplifier version. We install
      the bundle first so that step 5 overwrites with the correct PR version.
      
      ```
      shadow(operation="exec", shadow_id="<id>", command="uv tool install git+https://github.com/microsoft/amplifier-app-cli")
      ```
      
      This gives us a working amplifier to run bundle commands:
      ```
      shadow(operation="exec", shadow_id="<id>", command="amplifier provider install -q")
      shadow(operation="exec", shadow_id="<id>", command="amplifier bundle add git+https://github.com/samueljklee/amplifier-bundle-smoke-test --app")
      ```
      
      ### 5. NOW Install PR Code (Overwrites Bundle's Version)
      
      **CRITICAL**: This step MUST come AFTER bundle installation to ensure the PR code
      is what actually runs during smoke tests.
      
      ```
      shadow(operation="exec", shadow_id="<id>", command="uv tool install --force /workspace/{{pr_info.full_repo}}")
      ```
      
      Note: `--force` ensures it overwrites the version installed by the bundle.
      
      ### 6. Verify Installed Version
      
      ```
      shadow(operation="exec", shadow_id="<id>", command="amplifier --version")
      ```
      
      **MUST show**: `{{baseline.local_pr_commit_short}}` in the version string.
      
      If it shows a DIFFERENT commit, STOP and report failure. The PR code was not installed correctly.
      
      ### 7. Run Smoke Tests
      
      ```
      shadow(operation="exec", shadow_id="<id>", command="amplifier tool invoke recipes operation=execute recipe_path=@smoke-test:recipes/smoke-test.yaml context='{\"skip_llm\": {{skip_llm_smoke}}}'")
      ```
      
      ### 8. Final Version Check
      
      Verify version hasn't changed during smoke tests:
      ```
      shadow(operation="exec", shadow_id="<id>", command="amplifier --version")
      ```
      
      **MUST still show**: `{{baseline.local_pr_commit_short}}`
      
      If version changed, flag this as a concern - something in the smoke tests reinstalled amplifier.
      
      ### 9. Cleanup
      
      Destroy shadow (or preserve if failed for debugging).
      
      ---
      
      ## REQUIRED OUTPUT FORMAT
      
      ```
      ## Shadow Test Results for PR #{{pr_info.pr_number}}
      
      ### Source Verification (INJECT method)
      | Check | Expected | Actual | Status |
      |-------|----------|--------|--------|
      | Local clone commit | {{baseline.local_pr_commit_short}} | <actual> | PASS/FAIL |
      | Injected workspace commit | {{baseline.local_pr_commit_short}} | <from git rev-parse> | PASS/FAIL |
      | Installed version | {{baseline.local_pr_commit_short}} | <from --version> | PASS/FAIL |
      | Post-test version | {{baseline.local_pr_commit_short}} | <after smoke tests> | PASS/FAIL |
      
      ### Setup Status
      - Shadow created: PASS/FAIL
      - PR code injected: PASS/FAIL
      - Amplifier installed: PASS/FAIL
      - Providers installed: PASS/FAIL
      - Smoke bundle installed: PASS/FAIL
      
      ### Smoke Test Results
      <full output from smoke test recipe>
      
      ### Overall: PASS/FAIL
      
      **Shadow ID:** <id>
      ```
    output: "shadow_results"
    timeout: 1200

  # Step 3: Verify host wasn't affected
  - id: "post-shadow-verify"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      set -e
      
      # Get current host amplifier version
      CURRENT_VERSION=$(amplifier --version 2>&1 || echo "NOT_INSTALLED")
      BASELINE_VERSION="{{baseline.host_amplifier_version}}"
      
      echo "=== Host Amplifier Version Check ===" >&2
      echo "Before shadow: $BASELINE_VERSION" >&2
      echo "After shadow:  $CURRENT_VERSION" >&2
      
      if [ "$CURRENT_VERSION" != "$BASELINE_VERSION" ]; then
        echo "WARNING: Host amplifier version changed during shadow testing!" >&2
        echo "This should not happen - shadow environments are isolated." >&2
        echo "{\"host_unchanged\": false, \"before\": \"$BASELINE_VERSION\", \"after\": \"$CURRENT_VERSION\"}"
      else
        echo "Host amplifier unchanged (expected)." >&2
        echo "{\"host_unchanged\": true, \"version\": \"$CURRENT_VERSION\"}"
      fi
    output: "host_verify"
    parse_json: true
    timeout: 30

  # ============================================================================
  # PHASE 5: FINAL REPORT
  # ============================================================================

  - id: "synthesize"
    agent: "foundation:zen-architect"
    mode: "ARCHITECT"
    prompt: |
      Create final PR review report combining all analysis and test results.
      
      PR: {{pr_info.full_repo}}#{{pr_info.pr_number}}: {{pr_meta.title}}
      Author: {{pr_meta.author.login}}
      Commit: {{pr_meta.headRefOid}}
      
      Results:
      - Cross-repo contract check: {{cross_repo_result}}
      - Code review: {{code_review}}
      - Security review: {{security_review}}
      - Python checks: {{python_results}}
      - Shadow environment smoke tests: {{shadow_results}}
      - Host verification: {{host_verify}}
      
      Format as a GitHub PR comment with:
      1. Executive summary with overall verdict (APPROVE / REQUEST_CHANGES / COMMENT)
      2. Test results summary (PASS/FAIL for each category)
      3. Critical issues that must be addressed
      4. Suggestions for improvement
      5. Positive notes about the PR
    output: "report"
    timeout: 600

  - id: "save-report"
    type: "bash"
    command: |
      set -e
      WORKSPACE=$(echo "{{paths.workspace}}" | tr -d '\n\r')
      
      cat > "${WORKSPACE}/pr-{{pr_info.pr_number}}-review.md" << 'EOF'
      {{report}}
      EOF
      
      realpath "${WORKSPACE}/pr-{{pr_info.pr_number}}-review.md"
    output: "final_output"
    timeout: 30
