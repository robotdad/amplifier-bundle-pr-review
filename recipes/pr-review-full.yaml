name: "pr-review-full"
description: "Complete PR review workflow for amplifier-app-cli: fetch, analyze, test, and prepare findings"
version: "2.1.0"
author: "Amplifier PR Review Bundle"
tags: ["pr-review", "amplifier", "code-review", "security", "testing"]

# Usage:
#   amplifier tool invoke recipes operation=execute \
#     recipe_path=@pr-review:recipes/pr-review-full.yaml \
#     context='{"pr_url": "https://github.com/microsoft/amplifier-app-cli/pull/65"}'
#
# Required: GitHub CLI (gh) authenticated, Docker/Podman for shadow environments

context:
  pr_url: ""                    # Required: Full GitHub PR URL
  workspace_base: "./pr-review" # Where to clone repos (will be converted to absolute path)
  skip_shadow_tests: false      # Skip shadow environment tests
  skip_llm_smoke: false         # Skip LLM smoke tests

steps:
  # ============================================================================
  # PHASE 1: SETUP WORKSPACE (must run first to get absolute paths)
  # ============================================================================
  
  - id: "init-workspace"
    type: "bash"
    command: |
      # Create workspace and get absolute path
      mkdir -p "{{workspace_base}}"
      cd "{{workspace_base}}"
      WORKSPACE_ABS=$(pwd)
      
      # Output as JSON
      echo "{\"workspace\": \"${WORKSPACE_ABS}\"}"
    output: "paths"
    parse_json: true
    timeout: 30

  # ============================================================================
  # PHASE 2: FETCH PR INFORMATION
  # ============================================================================
  
  - id: "parse-pr-url"
    type: "bash"
    command: |
      PR_URL="{{pr_url}}"
      
      if [[ ! "$PR_URL" =~ github\.com/([^/]+)/([^/]+)/pull/([0-9]+) ]]; then
        echo "ERROR: Invalid PR URL format. Expected: https://github.com/owner/repo/pull/number"
        exit 1
      fi
      
      OWNER="${BASH_REMATCH[1]}"
      REPO="${BASH_REMATCH[2]}"
      PR_NUMBER="${BASH_REMATCH[3]}"
      
      echo "{\"owner\": \"$OWNER\", \"repo\": \"$REPO\", \"pr_number\": \"$PR_NUMBER\", \"full_repo\": \"$OWNER/$REPO\"}"
    output: "pr_info"
    parse_json: true
    timeout: 30

  - id: "fetch-pr-metadata"
    type: "bash"
    command: |
      gh pr view {{pr_info.pr_number}} \
        --repo {{pr_info.full_repo}} \
        --json title,body,headRefName,headRefOid,baseRefName,author,additions,deletions,changedFiles,url \
        2>/dev/null || echo '{"error": "Failed to fetch PR metadata"}'
    output: "pr_meta"
    parse_json: true
    timeout: 60

  - id: "fetch-changed-files"
    type: "bash"
    command: |
      gh pr diff {{pr_info.pr_number}} \
        --repo {{pr_info.full_repo}} \
        --name-only 2>/dev/null | sort -u | head -100
    output: "changed_files"
    timeout: 60

  # ============================================================================
  # PHASE 3: CLONE REPOS
  # ============================================================================

  - id: "clone-pr-repo"
    type: "bash"
    command: |
      cd "{{paths.workspace}}"
      
      REPO="{{pr_info.full_repo}}"
      BRANCH="{{pr_meta.headRefName}}"
      REPO_DIR="{{pr_info.repo}}"
      
      if [ -d "$REPO_DIR" ]; then
        echo "Repo exists, updating..."
        cd "$REPO_DIR"
        git fetch origin "$BRANCH"
        git checkout "$BRANCH"
        git pull origin "$BRANCH"
      else
        echo "Cloning $REPO branch $BRANCH..."
        gh repo clone "$REPO" "$REPO_DIR" -- --branch "$BRANCH"
        cd "$REPO_DIR"
      fi
      
      ACTUAL=$(git rev-parse HEAD)
      EXPECTED="{{pr_meta.headRefOid}}"
      
      echo "Expected: $EXPECTED"
      echo "Actual:   $ACTUAL"
      
      # Output absolute path
      pwd
    output: "pr_repo_path"
    timeout: 300

  - id: "clone-core"
    type: "bash"
    command: |
      cd "{{paths.workspace}}"
      
      if [ -d "amplifier-core" ]; then
        echo "Core exists, updating..."
        cd amplifier-core && git fetch origin main && git checkout main && git pull
      else
        echo "Cloning amplifier-core..."
        gh repo clone microsoft/amplifier-core
        cd amplifier-core
      fi
      
      pwd
    output: "core_path"
    timeout: 180

  # ============================================================================
  # PHASE 4: CROSS-REPO CONTRACT CHECK
  # ============================================================================

  - id: "cross-repo-check"
    agent: "foundation:explorer"
    prompt: |
      CRITICAL: Check for cross-repo contract violations.
      
      PR repo: {{pr_repo_path}}
      Core repo: {{core_path}}
      
      1. Find function/method signature changes in the PR (especially resolvers, protocols)
      2. Search core for usages of those interfaces
      3. Flag if core calls methods with parameters the PR removed
      
      Report: SAFE or WARNING with details
    output: "cross_repo_result"
    timeout: 300

  # ============================================================================
  # PHASE 5: SHADOW ENVIRONMENT TESTING
  # ============================================================================

  - id: "create-shadow"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      echo "Creating shadow with local PR code..."
      echo "PR repo path: {{pr_repo_path}}"
      
      amplifier tool invoke shadow \
        operation=create \
        name="pr-review-{{pr_info.pr_number}}" \
        local_sources="[\"{{pr_repo_path}}:{{pr_info.full_repo}}\"]"
    output: "shadow"
    parse_json: true
    timeout: 300

  - id: "shadow-install"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      echo "Installing Amplifier from LOCAL clone..."
      
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="uv tool install /workspace/{{pr_info.full_repo}} && amplifier --version"
      
      echo ""
      echo "Installing providers..."
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier provider install -q 2>/dev/null || true"
      
      echo ""
      echo "Installing smoke test bundle..."
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier bundle add git+https://github.com/samueljklee/amplifier-bundle-smoke-test --app"
    output: "install_result"
    timeout: 600

  - id: "shadow-smoke-test"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      echo "Running smoke tests..."
      
      amplifier tool invoke shadow \
        operation=exec \
        shadow_id="{{shadow.shadow_id}}" \
        command="amplifier tool invoke recipes operation=execute recipe_path=@smoke-test:recipes/smoke-test.yaml context='{\"skip_llm\": {{skip_llm_smoke}}}'"
    output: "smoke_results"
    timeout: 900

  - id: "destroy-shadow"
    type: "bash"
    condition: "{{skip_shadow_tests}} != true"
    command: |
      amplifier tool invoke shadow \
        operation=destroy \
        shadow_id="{{shadow.shadow_id}}"
    output: "cleanup"
    on_error: "continue"
    timeout: 60

  # ============================================================================
  # PHASE 6: CODE REVIEW
  # ============================================================================

  - id: "code-review"
    agent: "foundation:zen-architect"
    mode: "REVIEW"
    prompt: |
      Review PR for code quality and architecture.
      
      **PR:** {{pr_info.full_repo}}#{{pr_info.pr_number}} - {{pr_meta.title}}
      **Changed files:** {{changed_files}}
      **Repo path:** {{pr_repo_path}}
      
      Assess: architecture, code quality, Amplifier-specific concerns.
      Provide specific recommendations with priority levels.
    output: "code_review"
    timeout: 600

  - id: "security-review"
    agent: "foundation:security-guardian"
    prompt: |
      Security audit of PR changes.
      
      **PR:** {{pr_info.full_repo}}#{{pr_info.pr_number}}
      **Changed files:** {{changed_files}}
      **Repo path:** {{pr_repo_path}}
      
      Check: OWASP issues, command injection, path traversal, secrets, dependencies.
    output: "security_review"
    timeout: 600

  - id: "python-check"
    type: "bash"
    command: |
      amplifier tool invoke python_check \
        paths="[\"{{pr_repo_path}}\"]" \
        2>&1 || echo "Python check completed"
    output: "python_results"
    timeout: 300

  # ============================================================================
  # PHASE 7: GENERATE REPORT
  # ============================================================================

  - id: "synthesize"
    agent: "foundation:zen-architect"
    mode: "ARCHITECT"
    prompt: |
      Create PR review report.
      
      ## PR Info
      - {{pr_info.full_repo}}#{{pr_info.pr_number}}: {{pr_meta.title}}
      - Author: {{pr_meta.author.login}}
      - Commit: {{pr_meta.headRefOid}}
      
      ## Results
      - Cross-repo check: {{cross_repo_result}}
      - Shadow install: {{install_result}}
      - Smoke tests: {{smoke_results}}
      - Code review: {{code_review}}
      - Security: {{security_review}}
      - Python: {{python_results}}
      
      Format as GitHub PR comment with:
      1. Executive summary (APPROVE/REQUEST_CHANGES/COMMENT)
      2. Test results (PASS/FAIL)
      3. Critical issues
      4. Suggestions
      5. Positive notes
    output: "report"
    timeout: 600

  - id: "save-report"
    type: "bash"
    command: |
      cat > "{{paths.workspace}}/pr-{{pr_info.pr_number}}-review.md" << 'EOF'
      {{report}}
      EOF
      
      realpath "{{paths.workspace}}/pr-{{pr_info.pr_number}}-review.md"
    output: "final_output"
    timeout: 30
